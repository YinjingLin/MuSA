# MuSA  
  
The Multiscale Snow Assimilation System (MuSA), is a flexible data  assimilation toolbox for experimental and operational snowpack  reanalysis development. MuSA was designed to fuse gridded observations  with and ensemble of simulations generated by the Flexible Snow Model  [(FSM2)](https://github.com/RichardEssery/FSM2) by using different  Bayesian based data assimilation algorithms. 
  
### Inputs  
  
The inputs of MuSA are composed by meteorological forcing and  observations to be assimilated. Both the forcing and observations must  share the **same geometry**, with the same resolution and number of  cells in the latitudinal and longitudinal axes, and should be probided in the [netCDF](https://www.unidata.ucar.edu/software/netcdf/) format. In this version, the meteorological forcing must be provided in an hourlly basis. Optionally it is  possible to provide a mask with the same geometry of the mandatory input  files to avoid to run MuSA over certain cells of your domain. The  meteorological forcing needed for running MuSA is composed by: 
- Incident shortwave radiation (W m$^{-2}$) 
- Incident longwave radiation (W m$^{-2}$) 
- Precipitation (m$^{-2}$ s$^{-1}$) 
- Temperature (K) 
- Relative Humidity (%) 
- Wind speed (m s$^{-1}$) 
- Atmospheric pressure (Pa) 
  
In its current version MuSA provides support for assimilating different  variables. Note that it is possible to provide more than one of the  following variables at the same time, i.e. MuSA has support for joint  assimilation experiments. In its current version, MuSA is able to assimilate: 
- SWE (mm) 
- Snow depth (m) 
- Land/Snow surface temperature (K) 
- Snow cover area (binary) 
- Fractional snow cover area (-) 
- Albedo (-) 

The support of other variables like liquid water content, density, ice content etc.  could be relatively easily implemented on demand. 
  
### Data assimilation algorithms
There several different data assimilation algortihms and resampling algorithms implemented in MuSA.  Some testing should be done when developing data assimilation experiments, as the performance may be different depending on the problem to solve, and regarding the litearature there is not a clear winner. Also, the computational cost will be different, and may be a strong conditioner in some situations.

Filters:
-   Particle Filter (PF (C))
-   Particle filter with varying perturbation parameters (PF (R))
-   Ensemble Kalman filter (EnKF)
-   Iterative ensemble Kalman filter (IEnKF)

Smoothers:
-   Particle batch smoother (PBS)
-   Ensemble smoother (ES)
-   Iterative ensemble smoother (IES)
    
Resampling (for particle filters only):
-   Bootstrapping
-   Residual resampling
-   Stratified resampling
-   Systematic resampling

### Outputs
The outputs of MuSA are composed by simple .csv files containing the following information:
-  **OL_lonid_latid**: This file contains the open loop simulation (snow simulation without any assimilation).
-  **updated_lonid_latid**: This file contains the updated simulation after the assimilation, i.e. weighted mean of the ensemble of simulaitons.
-  **sd_lonid_latid**: This file contains the weighted standar deviation of the ensemble after the assimilation.
-  **DA_lonid_latid**: This fille contains information about the observed variables and perturbation parametesr used to generate the ensemble.

**lonid** and **latid** are the longitude and latitude ids of each cell of the simulation.

Aditionaly it is possible to store the ensembles generated for each cell. This is an optional feature as it may be a bit memory consuming. However It may be usefulll in some circustancies specially for advanced users. The ensembles will be stored as pickle objects, and will be composed by python lists containing [Ensemble objects](https://github.com/ealonsogzl/MuSA/blob/master/modules/internal_class.py).

### Usage

This version only works in GNU/Linux based platforms (and therefore in Mac). I guess it should be possible to run MuSA easilly in Windows using WSL, but we did not test this yet. MuSA depends on python3 with the regular scientific libraries (numpy, pandas, scipy...) and netCDF4 installed. Also it will be necesary to have a fortran compiler such as gfortran in the path. The easiest way to go is through generating a dedicated conda environtment. Then, simply:

```
python main.py
```

This command should run the reproducible example included in the repository. This example contains all the information needed by MuSA. It is composed by few cells containing meteorological forcing and drone SfM derived snowdepth information. To change the configuration of MuSA, you should modify the **config** file. Also it is posible to modify the way MuSA generates de ensemble by modifing the **constants** file.
An [example](https://github.com/ealonsogzl/MuSA/blob/master/run_PBS.pbs) is also provided to run MuSA in distributed supercomputing facilitites using PBS arrays.
### How to cite
#### MuSA
#### FSM2
-  Essery, R.: A factorial snowpack model (FSM 1.0), Geosci. Model Dev., 8, 3867–3876, https://doi.org/10.5194/gmd-8-3867-2015, 2015. 
### Related references
-   Alonso-González, E., Gutmann, E., Aalstad, K., Fayad, A., Bouchet, M., and Gascoin, S.: Snowpack dynamics in the Lebanese mountains from quasi-dynamically downscaled ERA5 reanalysis updated by assimilating remotely sensed fractional snow-covered area, Hydrol. Earth Syst. Sci., 25, 4455–4471, https://doi.org/10.5194/hess-25-4455-2021, 2021. 
-   Aalstad, K., Westermann, S., Schuler, T. V., Boike, J., and Bertino, L.: Ensemble-based assimilation of fractional snow-covered area satellite retrievals to estimate the snow distribution at Arctic sites, The Cryosphere, 12, 247–270, https://doi.org/10.5194/tc-12-247-2018, 2018.
