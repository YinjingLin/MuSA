rm(list=ls())
gc()
library(terra)
library(snowfall)
# Leer datos
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
#Generar mascara
#create manual mask in QGIS to remove border artifacts and read the mask
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
# Enmascarar
## Hay que hacer un loop copiando a disco, si no es carisimo
files = list.files('/home/wuesteban/GIT/FOREST_DA/micromet', full.names = T)
maskna = function(x){
temp = x[1:7993]
mask = x[7994]
if (is.na(mask))
temp[]=NA
return(temp)
}
skyview = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/skyview/skyview.tif")
skyview =resample(skyview, prec)
skyview[is.na(manual_mask)] = NA
times_static = rep(1,nlyr(prec))
skyview = skyview * times_static
time(skyview) = time(prec)
namefile = "/home/wuesteban/GIT/FOREST_DA/forz/skyview.nc"
writeCDF(skyview, namefile, compression=5, overwrite = T, split = F, varname="skyview",
longname="skyview", unit="-")
tmpFiles(remove = T)
file = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
plot)file
skyview
plot(skyview)
library(terra)
file = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
plot(file)
file[file == 0 ] = NA
plot(file)
file = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
plot(file)
file
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
dem
prec
file = resample(file, prec)
file
plot(file)
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
file[is.na(manual_mask)] = NA
manual_mask
file
plot(file)
=strptime("2011-03-27 01:30:00", "%Y-%m-%d %H:%M:%S")
strptime("2011-03-27 01:30:00", "%Y-%m-%d %H:%M:%S")
time(prec)
strptime("2011-03-27 01:30:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
time(prec)[1]
time(prec)[2]
longname(opensd) ="snow depth in forest gaps"
#open
opensd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
opensd = resample(opensd, prec)
opensd[is.na(manual_mask)] = NA
time(opensd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
varname(opensd) = "openSD"
longname(opensd) ="snow depth in forest gaps"
#todo
sds(opensd, allsd, undersd)
library(terra)
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
#open
opensd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD.tif")
opensd = resample(opensd, prec)
opensd[is.na(manual_mask)] = NA
time(opensd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
allsd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
allsd = resample(allsd, prec)
allsd[is.na(manual_mask)] = NA
time(allsd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
# debajo
undersd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_tall.tif")
undersd = resample(undersd, prec)
undersd[is.na(manual_mask)] = NA
time(undersd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
sds(opensd, allsd, undersd)
library(terra)
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
#open
opensd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD.tif")
opensd = resample(opensd, prec)
opensd[is.na(manual_mask)] = NA
time(opensd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
allsd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
allsd = resample(allsd, prec)
allsd[is.na(manual_mask)] = NA
time(allsd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
# debajo
undersd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_tall.tif")
undersd = resample(undersd, prec)
undersd[is.na(manual_mask)] = NA
time(undersd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
todo = sds(opensd, allsd, undersd)
varnames(todo) = c("openSD", "allSD", "underSD")
units(todo) = c("m", "m", "m")
longnames(todo) =c("snow depth in forest gaps",
"snowdepth",
"snow depth under canopy")
namefile = "/home/wuesteban/GIT/FOREST_DA/forz/observations.nc"
writeCDF(veght, namefile, compression=5, overwrite = T, split = F,over)
writeCDF(todo, namefile, compression=5, overwrite = T, split = F,over)
writeCDF(todo, namefile, compression=5, overwrite = T, split = F,over)
library(terra)
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
#open
opensd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD.tif")
opensd = resample(opensd, prec)
opensd[is.na(manual_mask)] = NA
time(opensd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
allsd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
allsd = resample(allsd, prec)
allsd[is.na(manual_mask)] = NA
time(allsd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
# debajo
undersd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_tall.tif")
undersd = resample(undersd, prec)
undersd[is.na(manual_mask)] = NA
time(undersd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
todo = sds(opensd, allsd, undersd)
varnames(todo) = c("openSD", "allSD", "underSD")
units(todo) = c("m", "m", "m")
longnames(todo) =c("snow depth in forest gaps",
"snowdepth",
"snow depth under canopy")
namefile = "/home/wuesteban/GIT/FOREST_DA/forz/observations.nc"
writeCDF(todo, namefile, compression=5, overwrite = T, split = F,over)
writeCDF(todo, namefile, compression=5, overwrite = T, split = F)
writeCDF(todo, namefile, compression=5, overwrite = T)
library(terra)
dem = rast('/home/wuesteban/GIT/FOREST_DA/elev.tif')
prec = rast('/home/wuesteban/GIT/FOREST_DA/micromet/prec.nc')
# Proyectar
crs(prec)=crs(dem)
template = prec[[1]]
template[]=NA
manual_mask = vect('/home/wuesteban/GIT/FOREST_DA/manual_mask.shp')
manual_mask = rasterize(manual_mask, template)
#open
opensd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_open.tif")
opensd = resample(opensd, prec)
opensd[is.na(manual_mask)] = NA
time(opensd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
allsd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD.tif")
allsd = resample(allsd, prec)
allsd[is.na(manual_mask)] = NA
time(allsd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
# debajo
undersd = rast("/home/wuesteban/GIT/FOREST_DA/obs_params/For_Esteban/NCALM_SCB_20220321_SD_tall.tif")
undersd = resample(undersd, prec)
undersd[is.na(manual_mask)] = NA
time(undersd) = strptime("2022-03-21 12:00:00", "%Y-%m-%d %H:%M:%S", tz="UTC")
#todo
todo = sds(opensd, allsd, undersd)
varnames(todo) = c("openSD", "allSD", "underSD")
units(todo) = c("m", "m", "m")
longnames(todo) =c("snow depth in forest gaps",
"snowdepth",
"snow depth under canopy")
namefile = "/home/wuesteban/GIT/FOREST_DA/forz/observations.nc"
writeCDF(todo, namefile, compression=5, overwrite = T)
plot(manual_mask)
#mascara
namefile = "/home/wuesteban/GIT/FOREST_DA/forz/mask.nc"
writeCDF(manual_mask, namefile, compression=5, overwrite = T)
